name: 'AutoCoder'
description: 'Generates code from GitHub issues using ChatGPT and creates a pull request.'
author: 'AlyonaKlekovkina'

inputs:
  GITHUB_TOKEN:
    description: 'Personal access token (PAT) used for GitHub API authentication.'
    required: true
  REPOSITORY:
    description: 'Repository where the action will be executed (e.g., user/repo).'
    required: true
  ISSUE_NUMBER:
    description: 'Issue number that triggered the action.'
    required: true
  OPENAI_API_KEY:
    description: 'API key for OpenAI to generate code.'
    required: true
  SCRIPT_PATH:
    description: 'Path to the script that generates code.'
    required: true
    default: './scripts/script.sh'
  LABEL:
    description: 'Label that triggers the action.'
    required: true
    default: 'autocoder-bot'

runs:
  using: 'composite'
  steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up git identity and environment
      run: |
        git config --global user.name "autocoder-bot"
        git config --global user.email "actions@github.com"
        mkdir -p autocoder-bot
      shell: bash

    - name: Create output directory
      run: mkdir -p autocoder-bot

    - name: Generate code from issue
      run: |
        chmod +x ${{ inputs.SCRIPT_PATH }}
        ${{ inputs.SCRIPT_PATH }} \
          "${{ inputs.GITHUB_TOKEN }}" \
          "${{ inputs.REPOSITORY }}" \
          "${{ inputs.ISSUE_NUMBER }}" \
          "${{ inputs.OPENAI_API_KEY }}"
      shell: bash

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: autocoder-artifact
        path: autocoder-bot/

    - name: Download Artifact
      uses: actions/download-artifact@v4
      with:
        name: autocoder-artifact
        path: autocoder-artifact/

    - name: Display Generated Code using the ls command
      run: ls -R autocoder-artifact/

    - name: Copy generated files into repo
      run: |
        cp -r autocoder-artifact/* .

    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v7
      with:
        token: ${{ inputs.GITHUB_TOKEN }}
        branch: autocoder-branch-${{ github.event.issue.number }}
        title: "Autocoder generated code for issue #${{ github.event.issue.number }}"
        body: "This pull request includes code automatically generated for issue #${{ github.event.issue.number }}."
        labels: autocoder-bot
        committer: "autocoder-bot <actions@github.com>"
        author: "autocoder-bot <actions@github.com>"
