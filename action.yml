name: 'AutoCoder'
description: 'This action automates the process of generating code from GitHub issues using OpenAIs ChatGPT and subsequently creates a pull request with the generated code for review.'
author: 'AlyonaKlekovkina'

inputs:
  github_token:
    description: 'Personal access token (PAT) used for GitHub API authentication.'
    required: true
  repository:
    description: 'Repository where the action will be executed (e.g., user/repo).'
    required: true
  issue_number:
    description: 'Issue number that triggered the action.'
    required: true
  openai_api_key:
    description: 'API key for OpenAI.'
    required: true
  script_path:
    description: 'Path to the script that interacts with ChatGPT and generates code.'
    required: true
  label:
    description: 'The label that triggers the action.'
    required: true
    default: 'autocoder-bot'

outputs:
  pull_request_url:
    description: 'The URL of the created pull request.'

runs:
  using: 'composite'
  steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up environment
      run: |
        git config --global user.name "autocoder-bot"
        git config --global user.email "actions@github.com"
        mkdir -p autocoder-bot
      shell: bash

    - name: Generate code
      run: |
        chmod +x ${{ inputs.script_path }}
        ${{ inputs.script_path }}
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.github_token }}
        REPOSITORY: ${{ inputs.repository }}
        ISSUE_NUMBER: ${{ inputs.issue_number }}
        OPENAI_API_KEY: ${{ inputs.OPENAI_API_KEY }}
        LABEL: ${{ inputs.label }}

    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v7
      with:
        token: ${{ inputs.github_token }}
        branch: autocoder-branch-${{ inputs.issue_number }}
        title: "Autocoder: Code for issue #${{ inputs.issue_number }}"
        body: "Automatically generated code for issue #${{ inputs.issue_number }}"
        labels: ${{ inputs.label }}
        commit-message: "Add code for issue #${{ inputs.issue_number }}"
        committer: "autocoder-bot <actions@github.com>"
        author: "autocoder-bot <actions@github.com>"
